openapi: 3.0.3
info:
  title: Monitoring Protocol Ingest API
  version: 1.0.0
  description: |
    Binary frame ingest surface used for interoperability testing and diagnostics.
    Frames are length-prefixed and include an explicit message type discriminant (1–7).
    NOTE: This OpenAPI document is for diagnostics/interoperability reference only.
    Implementing an HTTP ingest endpoint is out of scope for this feature unless
    explicitly added as a requirement.
servers:
  - url: https://localhost:8443
paths:
  /ingest/frame:
    post:
      summary: Accept a binary protocol frame
      operationId: postFrame
      requestBody:
        required: true
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
            description: Length-prefixed frame with CRC32 checksum, message_type discriminant 1–7, and payload encoded per schema.
      responses:
        '204':
          description: Frame accepted
        '400':
          description: Invalid frame (length mismatch, checksum failure, unknown discriminant)
        '429':
          description: Backpressure active; sender should throttle
components:
  schemas:
    Envelope:
      type: object
      properties:
        versionMajor:
          type: integer
          format: int32
          description: Protocol version major byte.
        versionMinor:
          type: integer
          format: int32
          description: Protocol version minor byte.
        messageType:
          type: integer
          format: int32
          description: 1=Handshake, 2=HandshakeAck, 3=Heartbeat, 4=Snapshot, 5=Ack, 6=Backpressure, 7=Error
        messageId:
          type: string
          format: uuid
          description: Unique per frame/part; used for acking and server de-duplication. On-wire the binary protocol encodes this as 16 raw bytes.
        timestampUtc:
          type: integer
          format: int64
        agentId:
          type: string
        platform:
          type: string
          enum: [windows, linux, macos]
        capabilities:
          type: object
          properties:
            supportsCompression:
              type: boolean
            supportsAllProcesses:
              type: boolean
            cmdlineIncluded:
              type: boolean
    Snapshot:
      type: object
      properties:
        snapshotId:
          type: string
          format: uuid
          description: Common id across segmented snapshot parts. On-wire the binary protocol encodes this as 16 raw bytes.
        partIndex:
          type: integer
          format: int32
          description: 0-based part index when segmented.
        partCount:
          type: integer
          format: int32
          description: Total parts when segmented.
        windowStart:
          type: integer
          format: int64
        windowEnd:
          type: integer
          format: int64
        cpuTotalPct:
          type: number
          format: float
        memUsedBytes:
          type: integer
          format: int64
        memTotalBytes:
          type: integer
          format: int64
        processes:
          type: array
          items:
            $ref: '#/components/schemas/ProcessSample'
    Backpressure:
      type: object
      properties:
        throttleDelayMs:
          type: integer
          format: int32
          description: Throttle delay in milliseconds the agent applies to its snapshot send rate (0 = no throttle).
        reason:
          type: string
        timestampUtc:
          type: integer
          format: int64
    ProcessSample:
      type: object
      properties:
        pid:
          type: integer
          format: int32
        name:
          type: string
        cpuPct:
          type: number
          format: float
        memPct:
          type: number
          format: float
        rssBytes:
          type: integer
          format: int64
        cmdline:
          type: string
        rank:
          type: integer
          format: int32
